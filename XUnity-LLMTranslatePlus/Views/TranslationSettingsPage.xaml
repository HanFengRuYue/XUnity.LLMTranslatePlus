<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="XUnity_LLMTranslatePlus.Views.TranslationSettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:XUnity_LLMTranslatePlus.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <ScrollViewer Padding="0,0,16,0">
        <StackPanel Spacing="24" Margin="0,0,0,24">
            <!-- 页面标题 -->
            <TextBlock Text="翻译设置" Style="{StaticResource TitleTextBlockStyle}"/>

            <!-- XUnity 配置 -->
            <Expander Header="XUnity 配置" IsExpanded="True" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                <StackPanel Spacing="12" Margin="0,12,0,0" HorizontalAlignment="Stretch">
                        <!-- 游戏根目录 -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="游戏根目录"/>
                            <Grid ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBox x:Name="GameDirectoryTextBox" 
                                         Grid.Column="0"
                                         IsReadOnly="True"
                                         PlaceholderText="点击浏览按钮选择游戏目录"/>
                                
                                <Button Grid.Column="1" 
                                        Content="浏览..." 
                                        Click="BrowseGameDirButton_Click"/>
                            </Grid>
                        </StackPanel>

                        <!-- 自动检测路径 -->
                        <ToggleSwitch x:Name="AutoDetectPathToggle"
                                      Header="自动检测 Translation 路径"
                                      IsOn="True"
                                      OnContent="已启用"
                                      OffContent="已禁用"
                                      Toggled="AutoDetectPathToggle_Toggled"/>

                    <!-- 手动指定翻译文件 -->
                    <StackPanel x:Name="ManualFilePanel" Spacing="4" Visibility="Collapsed">
                        <TextBlock Text="手动指定翻译文件（自动检测失败时使用）"/>
                        <Grid ColumnSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBox x:Name="ManualFilePathTextBox"
                                     Grid.Column="0"
                                     IsReadOnly="True"
                                     PlaceholderText="点击浏览按钮选择 _AutoGeneratedTranslations.txt 文件"/>

                            <Button Grid.Column="1"
                                    Content="浏览..."
                                    Click="BrowseManualFileButton_Click"/>

                            <Button Grid.Column="2"
                                    Content="清除"
                                    Click="ClearManualFileButton_Click"/>
                        </Grid>
                    </StackPanel>

                    <!-- 当前 Translation 文件路径 -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="当前 Translation 文件路径"/>
                        <TextBlock x:Name="CurrentTranslationPathText"
                                   Text="未检测到"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 翻译选项 -->
            <Expander Header="翻译选项" IsExpanded="True" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                <StackPanel Spacing="12" Margin="0,12,0,0" HorizontalAlignment="Stretch">
                        <!-- 目标语言 -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="目标语言"/>
                            <ComboBox x:Name="TargetLanguageComboBox"
                                      SelectedIndex="0"
                                      HorizontalAlignment="Stretch"
                                      SelectionChanged="TargetLanguageComboBox_SelectionChanged">
                                <ComboBoxItem Content="简体中文"/>
                                <ComboBoxItem Content="繁体中文"/>
                                <ComboBoxItem Content="英语"/>
                                <ComboBoxItem Content="日语"/>
                                <ComboBoxItem Content="韩语"/>
                                <ComboBoxItem Content="俄语"/>
                                <ComboBoxItem Content="法语"/>
                                <ComboBoxItem Content="德语"/>
                            </ComboBox>
                        </StackPanel>

                        <!-- 源语言 -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="源语言"/>
                            <ComboBox x:Name="SourceLanguageComboBox"
                                      SelectedIndex="0"
                                      HorizontalAlignment="Stretch"
                                      SelectionChanged="SourceLanguageComboBox_SelectionChanged">
                                <ComboBoxItem Content="自动检测"/>
                                <ComboBoxItem Content="日语"/>
                                <ComboBoxItem Content="英语"/>
                                <ComboBoxItem Content="韩语"/>
                                <ComboBoxItem Content="简体中文"/>
                                <ComboBoxItem Content="繁体中文"/>
                            </ComboBox>
                        </StackPanel>

                        <!-- 保留特殊符号 -->
                        <CheckBox x:Name="PreserveSpecialCharsCheckBox" 
                                  Content="保留游戏文本中的转义符和特殊符号" 
                                  IsChecked="True"/>

                        <!-- 实时监控 -->
                        <ToggleSwitch x:Name="RealTimeMonitoringToggle"
                                      Header="实时监控翻译文件"
                                      IsOn="True"
                                      OnContent="已启用"
                                      OffContent="已禁用"
                                      Toggled="RealTimeMonitoringToggle_Toggled"/>

                        <!-- 文本聚合（打字机效果优化） -->
                        <ToggleSwitch x:Name="EnableTextAggregationToggle"
                                      Header="启用文本聚合（应对打字机效果）"
                                      IsOn="True"
                                      OnContent="已启用"
                                      OffContent="已禁用"
                                      Toggled="EnableTextAggregationToggle_Toggled"/>

                        <!-- 文本聚合配置面板 -->
                        <StackPanel x:Name="TextAggregationConfigPanel"
                                    Spacing="12"
                                    Visibility="Visible">
                            <!-- 聚合延迟时间 -->
                            <StackPanel Spacing="4">
                                <TextBlock>
                                    <Run Text="文本聚合延迟时间："/>
                                    <Run x:Name="AggregationDelayValueText" Text="2.0" FontWeight="SemiBold"/>
                                    <Run Text=" 秒"/>
                                </TextBlock>
                                <Slider x:Name="TextAggregationDelaySlider"
                                        Minimum="1.0"
                                        Maximum="10.0"
                                        StepFrequency="0.5"
                                        TickFrequency="1.0"
                                        TickPlacement="BottomRight"
                                        Value="2.0"
                                        ValueChanged="TextAggregationDelaySlider_ValueChanged"/>
                            </StackPanel>

                            <InfoBar Severity="Informational"
                                     IsOpen="True"
                                     IsClosable="False"
                                     Message="启用文本聚合可以应对游戏打字机效果，避免翻译未完成的句子。延迟时间决定等待文本稳定多久后再翻译。"/>
                        </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 上下文配置 -->
            <Expander Header="上下文配置" IsExpanded="False" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                <StackPanel Spacing="12" Margin="0,12,0,0" HorizontalAlignment="Stretch">
                        <!-- 启用上下文参考 -->
                        <ToggleSwitch x:Name="EnableContextToggle"
                                      Header="启用上下文参考"
                                      IsOn="True"
                                      OnContent="已启用"
                                      OffContent="已禁用"
                                      Toggled="EnableContextToggle_Toggled"/>

                        <!-- 上下文配置面板 -->
                        <StackPanel x:Name="ContextConfigPanel"
                                    Spacing="12"
                                    Visibility="Visible">
                            <!-- 上下文行数 -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="上下文记录数量"/>
                                <NumberBox x:Name="ContextLinesNumberBox"
                                           Value="10"
                                           Minimum="1"
                                           Maximum="100"
                                           SpinButtonPlacementMode="Inline"
                                           ValueChanged="ContextLinesNumberBox_ValueChanged"/>
                            </StackPanel>

                        <InfoBar Severity="Informational" 
                                 IsOpen="True" 
                                 IsClosable="False"
                                 Message="启用上下文参考可以提高翻译质量，但会增加 API 调用成本。"/>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!-- 输出配置 -->
            <Expander Header="输出配置" IsExpanded="False" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                <StackPanel Spacing="12" Margin="0,12,0,0" HorizontalAlignment="Stretch">
                        <ToggleSwitch x:Name="EnableCacheToggle"
                                      Header="启用翻译缓存（避免重复翻译相同文本）"
                                      IsOn="True"
                                      OnContent="已启用"
                                      OffContent="已禁用"
                                      Toggled="EnableCacheToggle_Toggled"/>

                    <CheckBox x:Name="ExportLogCheckBox"
                              Content="导出翻译日志（记录所有翻译操作）"
                              IsChecked="False"/>
                </StackPanel>
            </Expander>

            <!-- 系统提示词 -->
            <Expander Header="系统提示词" IsExpanded="False" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                <StackPanel Spacing="12" Margin="0,12,0,0" HorizontalAlignment="Stretch">
                    <!-- 提示词变量说明 -->
                    <InfoBar Severity="Informational"
                             IsOpen="True"
                             IsClosable="False"
                             Message="可用变量：{目标语言}、{原文}、{术语}、{上下文}"/>

                    <!-- 提示词模板 -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="提示词模板"/>
                        <TextBox x:Name="SystemPromptTextBox"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 Height="180"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                                 HorizontalAlignment="Stretch"
                                 Text="你是一个专业的游戏文本翻译助手。请将以下文本翻译成{目标语言}。保持原文的语气和风格，确保翻译准确、流畅、自然。&#xA;&#xA;【重要】如果文本中包含形如【SPECIAL_数字】的占位符，请务必在译文中完整保留这些占位符，不要翻译或修改它们。&#xA;&#xA;原文：{原文}&#xA;&#xA;术语参考：{术语}&#xA;&#xA;上下文参考：{上下文}&#xA;&#xA;请只输出翻译结果，不要包含任何解释或额外内容。"
                                 TextChanged="SystemPromptTextBox_TextChanged"/>
                    </StackPanel>

                    <!-- 重置按钮 -->
                    <Button Content="重置为默认" Click="ResetPromptButton_Click"/>
                </StackPanel>
            </Expander>

            <!-- 自动保存提示 -->
            <InfoBar Severity="Informational"
                     IsOpen="True"
                     IsClosable="False"
                     Message="所有设置更改将自动保存"/>
        </StackPanel>
    </ScrollViewer>
</Page>

